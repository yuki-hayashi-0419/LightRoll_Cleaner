# パフォーマンス最適化実装計画

## 概要

| 項目 | 値 |
|------|-----|
| 現状 | 115GB（100,000枚）で60-80分 |
| 目標 | 5-10分（90%改善） |
| 対象 | LightRoll Cleaner アプリ |
| 作成日 | 2025-12-25 |
| 作成者 | @spec-architect |

---

## 1. ボトルネック分析サマリー

### 1.1 特定されたボトルネック

| No | ボトルネック | 影響度 | 主要ファイル |
|----|------------|--------|-------------|
| 1 | `getFileSizes()`の繰り返し呼び出し | 40% | PhotoGrouper.swift:584-606 |
| 2 | `PHAsset.getFileSize()`のI/Oコスト | 25% | PHAsset+Extensions.swift:90-121 |
| 3 | 重複検出の逐次処理 | 15% | PhotoGrouper.swift:505-554 |
| 4 | LSHHasherの非効率 | 10% | LSHHasher.swift |
| 5 | 大容量動画の逐次処理 | 5% | PhotoGrouper.swift:453-498 |
| 6 | UserDefaultsの使用 | 3% | SettingsRepository.swift, AnalysisCacheManager.swift |

### 1.2 データフロー概要

```
[PHAsset取得] → [分析処理] → [グループ化] → [ファイルサイズ取得] → [結果生成]
                    ↓              ↓                ↓
              FeaturePrint抽出  類似度計算      getFileSizes()×N回
                    ↓              ↓                ↓
               キャッシュ保存    Union-Find      PHAssetResource I/O
```

---

## 2. 実装ロードマップ

### Phase 1: クイック修正（Day 1-5、目標50%改善）

| Day | タスクID | タスク名 | 工数 | 依存 | 期待改善率 |
|-----|---------|---------|------|------|-----------|
| 1 | A1-1 | groupDuplicates分析・設計 | 2h | - | - |
| 1 | A1-2 | TaskGroup実装 | 4h | A1-1 | 15% |
| 1 | A1-3 | テスト作成・実行 | 2h | A1-2 | - |
| 2 | A2-1 | groupLargeVideos分析・設計 | 1h | - | - |
| 2 | A2-2 | TaskGroup実装 | 3h | A2-1 | 5% |
| 2 | A2-3 | テスト作成・実行 | 2h | A2-2 | - |
| 3 | A3-1 | getFileSizes呼び出し分析 | 2h | - | - |
| 3 | A3-2 | バッチ制限実装 | 4h | A3-1 | 10% |
| 3 | A3-3 | テスト作成・実行 | 2h | A3-2 | - |
| 4 | A4-1 | estimatedFileSize調査 | 2h | - | - |
| 4 | A4-2 | 優先使用ロジック実装 | 4h | A4-1 | 20% |
| 4 | A4-3 | フォールバック実装 | 2h | A4-2 | - |
| 5 | P1-INT | Phase 1統合テスト | 4h | A1-A4 | - |
| 5 | P1-PERF | パフォーマンス計測 | 4h | P1-INT | - |

### Phase 2: 中規模改善（Day 6-15、追加30%改善）

| Day | タスクID | タスク名 | 工数 | 依存 | 期待改善率 |
|-----|---------|---------|------|------|-----------|
| 6-7 | B1-1 | PhotoAnalysisResult拡張設計 | 4h | - | - |
| 7-8 | B1-2 | fileSize プロパティ追加 | 4h | B1-1 | - |
| 8-9 | B1-3 | キャッシュ保存・読込対応 | 6h | B1-2 | - |
| 9-10 | B1-4 | グループ化ロジック統合 | 6h | B1-3 | 20% |
| 10 | B1-5 | マイグレーション実装 | 4h | B1-4 | - |
| 11 | B2-1 | マルチプローブLSH設計 | 2h | - | - |
| 11 | B2-2 | 実装・最適化 | 4h | B2-1 | 5% |
| 12 | B3-1 | 動的時間窓設計 | 2h | - | - |
| 12 | B3-2 | TimeBasedGrouper拡張 | 4h | B3-1 | 3% |
| 13 | B4-1 | インメモリキャッシュ分析 | 2h | - | - |
| 13-14 | B4-2 | キャッシュサイズ拡大 | 4h | B4-1 | 2% |
| 14-15 | P2-INT | Phase 2統合テスト | 6h | B1-B4 | - |
| 15 | P2-PERF | パフォーマンス計測 | 4h | P2-INT | - |

### Phase 3: 大規模改修（Day 16-30、追加15%改善）

| Day | タスクID | タスク名 | 工数 | 依存 | 期待改善率 |
|-----|---------|---------|------|------|-----------|
| 16-18 | C1-1 | SwiftData モデル設計 | 8h | - | - |
| 18-20 | C1-2 | エンティティ実装 | 8h | C1-1 | - |
| 20-22 | C1-3 | Repository層実装 | 8h | C1-2 | - |
| 22-24 | C1-4 | マイグレーション実装 | 8h | C1-3 | 10% |
| 24-26 | C2-1 | バックグラウンド処理設計 | 4h | - | - |
| 26-27 | C2-2 | BGTaskScheduler実装 | 6h | C2-1 | 3% |
| 27-28 | C3-1 | 差分グループ化設計 | 4h | - | - |
| 28-29 | C3-2 | 差分検出実装 | 6h | C3-1 | 2% |
| 29-30 | P3-INT | Phase 3統合テスト | 8h | C1-C3 | - |
| 30 | P3-PERF | 最終パフォーマンス計測 | 4h | P3-INT | - |

---

## 3. タスク依存関係図

```
Phase 1（並列可能）
┌─────────────────────────────────────────────────────────┐
│  A1 (groupDuplicates並列化)                             │
│  ├── A1-1 → A1-2 → A1-3                                 │
│                                                         │
│  A2 (groupLargeVideos並列化)                            │
│  ├── A2-1 → A2-2 → A2-3                                 │
│                                                         │
│  A3 (getFileSizesバッチ制限)                            │
│  ├── A3-1 → A3-2 → A3-3                                 │
│                                                         │
│  A4 (estimatedFileSize優先使用)                         │
│  ├── A4-1 → A4-2 → A4-3                                 │
└─────────────────────────────────────────────────────────┘
                          ↓ 統合テスト
┌─────────────────────────────────────────────────────────┐
│                    Phase 1 完了                          │
│                  目標: 30-40分達成                       │
└─────────────────────────────────────────────────────────┘
                          ↓
Phase 2（依存関係あり）
┌─────────────────────────────────────────────────────────┐
│  B1 (fileSize統合) ←─ [Phase 1完了必須]                 │
│  ├── B1-1 → B1-2 → B1-3 → B1-4 → B1-5                   │
│                                                         │
│  B2 (マルチプローブLSH) ←─ [独立]                       │
│  ├── B2-1 → B2-2                                        │
│                                                         │
│  B3 (動的時間窓) ←─ [独立]                              │
│  ├── B3-1 → B3-2                                        │
│                                                         │
│  B4 (キャッシュ拡大) ←─ [独立]                          │
│  ├── B4-1 → B4-2                                        │
└─────────────────────────────────────────────────────────┘
                          ↓ 統合テスト
┌─────────────────────────────────────────────────────────┐
│                    Phase 2 完了                          │
│                  目標: 15-20分達成                       │
└─────────────────────────────────────────────────────────┘
                          ↓
Phase 3（大規模改修）
┌─────────────────────────────────────────────────────────┐
│  C1 (SwiftData移行) ←─ [Phase 2完了推奨]                │
│  ├── C1-1 → C1-2 → C1-3 → C1-4                          │
│                                                         │
│  C2 (バックグラウンド処理) ←─ [C1完了後]                │
│  ├── C2-1 → C2-2                                        │
│                                                         │
│  C3 (差分グループ化) ←─ [C1完了後]                      │
│  ├── C3-1 → C3-2                                        │
└─────────────────────────────────────────────────────────┘
                          ↓ 最終テスト
┌─────────────────────────────────────────────────────────┐
│                    Phase 3 完了                          │
│                  目標: 5-10分達成                        │
└─────────────────────────────────────────────────────────┘
```

---

## 4. 工数見積もりサマリー

### Phase別工数

| Phase | 実装 | テスト | レビュー | バッファ | 合計 |
|-------|------|--------|----------|----------|------|
| Phase 1 | 24h | 10h | 4h | 6h | 44h (5.5日) |
| Phase 2 | 40h | 16h | 6h | 10h | 72h (9日) |
| Phase 3 | 48h | 20h | 8h | 12h | 88h (11日) |
| **合計** | **112h** | **46h** | **18h** | **28h** | **204h (25.5日)** |

### リソース配分

- 実装: 55%
- テスト: 23%
- レビュー: 9%
- バッファ: 13%

---

## 5. マイルストーン

| ID | マイルストーン | 日付 | 成功基準 |
|----|--------------|------|----------|
| M1 | Phase 1完了 | Day 5 | 30-40分達成、既存テスト100%パス |
| M2 | Phase 2完了 | Day 15 | 15-20分達成、新規テストカバレッジ80%+ |
| M3 | Phase 3完了 | Day 30 | 5-10分達成、本番環境安定稼働 |

---

## 6. リスク管理

| リスク | 確率 | 影響 | 対策 |
|--------|------|------|------|
| 並列化でのクラッシュ | 中 | 高 | 段階的ロールアウト、メモリ監視 |
| estimatedFileSize精度不足 | 高 | 中 | フォールバック実装、閾値調整 |
| SwiftDataマイグレーション失敗 | 中 | 高 | 既存データバックアップ、ロールバック手順 |
| キャッシュ肥大化 | 中 | 中 | 自動クリーンアップ、サイズ上限設定 |
| メモリ不足（大量写真） | 高 | 高 | バッチサイズ動的調整、メモリ警告対応 |

---

## 7. 品質基準

### 機能品質

- 既存テスト: 100%パス必須
- 新規テスト: カバレッジ80%以上
- UI/UX: 既存動作と同等

### パフォーマンス品質

| 指標 | Phase 1 | Phase 2 | Phase 3 |
|------|---------|---------|---------|
| 処理時間(100,000枚) | 30-40分 | 15-20分 | 5-10分 |
| メモリ使用量(ピーク) | <2GB | <1.5GB | <1GB |
| クラッシュ率 | <0.5% | <0.2% | <0.1% |

### 運用品質

- ログ出力: 処理時間、エラー発生率
- 監視: メモリ使用量、CPU使用率
- アラート: 処理時間閾値超過

---

## 8. 参照ドキュメント

- [Phase 1 実装ガイド](./PHASE1_IMPLEMENTATION_GUIDE.md)
- [Phase 2 実装ガイド](./PHASE2_IMPLEMENTATION_GUIDE.md)
- [Phase 3 実装ガイド](./PHASE3_IMPLEMENTATION_GUIDE.md)

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0 | 2025-12-25 | 初版作成 |
