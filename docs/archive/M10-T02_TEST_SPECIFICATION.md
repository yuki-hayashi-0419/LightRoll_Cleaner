# M10-T02テスト仕様書：スクリーンショット作成・検証

## タスク概要

- **タスクID**: M10-T02
- **タスク名**: スクリーンショット作成
- **フェーズ**: ⑥ タスク実装（テスト生成）
- **作成日**: 2025-12-13
- **対象成果物**:
  1. `scripts/generate_screenshots.sh`（スクリーンショット生成スクリプト）
  2. `screenshots/` ディレクトリ（生成された画像ファイル）

## テストの性質

このタスクは**スクリーンショット生成の自動化とその検証**のため、従来のユニットテストではなく、以下の観点で品質を検証します：

- スクリプトの実行可能性
- 生成ファイルの存在確認
- 画像解像度の正確性
- ファイル形式の妥当性
- ファイル命名規則の遵守
- エラーハンドリングの適切性

---

## スクリーンショット要件（App Store Connect基準）

### 必須デバイスサイズ（4種類）

| デバイス | 解像度 (縦向き) | 対象モデル |
|---------|----------------|------------|
| 6.9インチ | 1320 x 2868 px | iPhone 16 Pro Max / 15 Pro Max |
| 6.7インチ | 1290 x 2796 px | iPhone 16 Plus / 15 Plus / 14 Pro Max |
| 6.5インチ | 1242 x 2688 px | iPhone XS Max / 11 Pro Max |
| 5.5インチ | 1242 x 2208 px | iPhone 8 Plus / 7 Plus |

### 推奨スクリーンショット構成（5画面）

1. **ホーム画面**：ストレージ概要、スキャンボタン
2. **グループリスト画面**：自動グルーピング結果
3. **グループ詳細画面**：写真選択UI、ベストショット提案
4. **削除確認画面**：削除前の確認ダイアログ
5. **Premium画面**：課金プラン一覧

**合計**: 4デバイス × 5画面 = **20枚のスクリーンショット**

---

## テストケース一覧

### TC-01: スクリプト実行可能性確認

**目的**: スクリーンショット生成スクリプトが正常に実行できることを確認

**前提条件**:
- [ ] Xcodeがインストールされている
- [ ] xcrun simctl コマンドが使用可能
- [ ] アプリがビルドされている

**検証項目**:
- [ ] `scripts/generate_screenshots.sh` が存在する
- [ ] スクリプトに実行権限がある（chmod +x済み）
- [ ] スクリプトがエラーなく完走する
- [ ] 終了コードが0である

**検証方法**: Bashスクリプト自動検証

**合格基準**: スクリプトが正常終了し、エラーログが出力されない

**重要度**: 🔴 必須

---

### TC-02: 全スクリーンショットファイル生成確認

**目的**: 20枚すべてのスクリーンショットが生成されることを確認

**検証項目**:
- [ ] `screenshots/` ディレクトリが作成される
- [ ] 6.9インチ用スクリーンショット5枚が存在する
- [ ] 6.7インチ用スクリーンショット5枚が存在する
- [ ] 6.5インチ用スクリーンショット5枚が存在する
- [ ] 5.5インチ用スクリーンショット5枚が存在する
- [ ] 合計20枚のファイルが生成される

**ファイル命名規則**:
```
screenshots/6.9inch_01_home.png
screenshots/6.9inch_02_group_list.png
screenshots/6.9inch_03_group_detail.png
screenshots/6.9inch_04_delete_confirm.png
screenshots/6.9inch_05_premium.png
...（以下同様に6.7inch、6.5inch、5.5inch）
```

**検証方法**: Bashスクリプト自動検証（find コマンドでカウント）

**合格基準**: 20枚すべてのファイルが存在し、命名規則に従っている

**重要度**: 🔴 必須

---

### TC-03: 画像解像度正確性確認

**目的**: 各スクリーンショットが正しい解像度を持つことを確認

**検証項目**:
- [ ] 6.9インチ画像：1320 x 2868 px（全5枚）
- [ ] 6.7インチ画像：1290 x 2796 px（全5枚）
- [ ] 6.5インチ画像：1242 x 2688 px（全5枚）
- [ ] 5.5インチ画像：1242 x 2208 px（全5枚）

**検証方法**:
- Bashスクリプト自動検証（sips -g pixelWidth -g pixelHeight コマンド）
- ImageMagick の identify コマンド（利用可能な場合）

**合格基準**: 全20枚が指定解像度と完全一致

**実装例**:
```bash
# 6.9インチの解像度確認
for file in screenshots/6.9inch_*.png; do
  width=$(sips -g pixelWidth "$file" | tail -1 | awk '{print $2}')
  height=$(sips -g pixelHeight "$file" | tail -1 | awk '{print $2}')

  if [ "$width" -ne 1320 ] || [ "$height" -ne 2868 ]; then
    echo "❌ FAIL: $file - ${width}x${height} (期待値: 1320x2868)"
    exit 1
  fi
done
```

**重要度**: 🔴 必須

---

### TC-04: ファイル形式妥当性確認

**目的**: スクリーンショットが正しいファイル形式で保存されることを確認

**検証項目**:
- [ ] 全ファイルがPNG形式である
- [ ] sRGB色空間を使用している
- [ ] ファイルサイズが0バイトでない（空ファイルでない）
- [ ] 最小ファイルサイズ: 100KB以上（真っ黒画像などの異常を検出）
- [ ] 最大ファイルサイズ: 10MB以下（過度な容量を検出）

**検証方法**:
- Bashスクリプト自動検証（file コマンド）
- sips -g format コマンド

**合格基準**:
- 全ファイルが `PNG image data` として識別される
- ファイルサイズが 100KB 〜 10MB の範囲内

**実装例**:
```bash
for file in screenshots/*.png; do
  # ファイル形式確認
  file_type=$(file "$file" | grep -o "PNG image data")
  if [ -z "$file_type" ]; then
    echo "❌ FAIL: $file - PNG形式ではありません"
    exit 1
  fi

  # ファイルサイズ確認
  size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
  if [ "$size" -lt 102400 ]; then  # 100KB
    echo "❌ FAIL: $file - ファイルサイズが小さすぎます (${size} bytes)"
    exit 1
  fi
  if [ "$size" -gt 10485760 ]; then  # 10MB
    echo "❌ FAIL: $file - ファイルサイズが大きすぎます (${size} bytes)"
    exit 1
  fi
done
```

**重要度**: 🔴 必須

---

### TC-05: エラーハンドリング確認（異常系）

**目的**: スクリプトが適切なエラーハンドリングを行うことを確認

**検証シナリオ**:

#### シナリオ5-1: シミュレータ未起動時のエラー
- **条件**: すべてのシミュレータがシャットダウンされている
- **期待動作**: エラーメッセージを表示し、終了コード1で終了
- **検証方法**: 手動実行テスト
- **エラーメッセージ例**:
  ```
  ❌ エラー: iPhone 16 Pro Max シミュレータが起動していません
  以下のコマンドでシミュレータを起動してください:
  xcrun simctl boot [UDID]
  ```

#### シナリオ5-2: ディレクトリ作成失敗時のエラー
- **条件**: `screenshots/` ディレクトリが書き込み不可
- **期待動作**: エラーメッセージを表示し、終了コード1で終了
- **検証方法**: 手動実行テスト（chmod 000 screenshots/）
- **エラーメッセージ例**:
  ```
  ❌ エラー: screenshots/ ディレクトリを作成できません
  権限を確認してください
  ```

#### シナリオ5-3: アプリ未インストール時のエラー
- **条件**: シミュレータにアプリがインストールされていない
- **期待動作**: エラーメッセージを表示し、ビルド手順を案内
- **検証方法**: 手動実行テスト
- **エラーメッセージ例**:
  ```
  ❌ エラー: LightRoll Cleanerがインストールされていません
  以下のコマンドでビルドしてください:
  xcodebuild -workspace ... -scheme LightRoll_Cleaner -destination ...
  ```

**検証方法**: 手動実行テスト（異常系はシミュレートが必要）

**合格基準**: 各異常系で適切なエラーメッセージが表示され、スクリプトが適切に終了する

**重要度**: 🟡 推奨

---

## 検証ツール

### 1. Bash自動検証スクリプト

**ファイルパス**: `scripts/test_screenshots.sh`

**実行方法**:
```bash
# 1. スクリーンショット生成
./scripts/generate_screenshots.sh

# 2. 検証スクリプト実行
./scripts/test_screenshots.sh
```

**実行時間**: 約10秒

**検証項目**: TC-01〜TC-04（正常系4項目）

**出力形式**:
```
========================================
スクリーンショット検証
========================================

[Check 1/4] スクリプト実行可能性確認...
  ✓ PASS - generate_screenshots.sh が存在します
  ✓ PASS - 実行権限があります

[Check 2/4] ファイル生成確認...
  ✓ PASS - screenshots/ ディレクトリが存在します
  ✓ PASS - 6.9インチ: 5枚
  ✓ PASS - 6.7インチ: 5枚
  ✓ PASS - 6.5インチ: 5枚
  ✓ PASS - 5.5インチ: 5枚
  ✓ PASS - 合計20枚

[Check 3/4] 画像解像度確認...
  ✓ PASS - 6.9inch_01_home.png: 1320x2868
  ✓ PASS - 6.9inch_02_group_list.png: 1320x2868
  ...（全20枚分）

[Check 4/4] ファイル形式確認...
  ✓ PASS - 全ファイルがPNG形式です
  ✓ PASS - ファイルサイズが適切です（100KB〜10MB）

========================================
検証結果サマリー
========================================
総チェック数: 4
成功: 4
失敗: 0

✓ すべてのチェックが成功しました！
スクリーンショットはApp Store Connect要件を満たしています。
```

---

## 実装ファイル

### 1. スクリーンショット生成スクリプト

**ファイルパス**: `scripts/generate_screenshots.sh`

**概要**: 4種類のデバイスで5画面ずつスクリーンショットを自動生成

**主要機能**:
- シミュレータの起動確認
- アプリの自動起動
- 画面遷移の自動操作（UI Automation）
- 各デバイスサイズでのスクリーンショット撮影
- ファイル命名規則に従った保存

**依存ツール**:
- `xcrun simctl` - シミュレータ操作
- XcodeBuildMCP - UI操作・スクリーンショット撮影

---

### 2. スクリーンショット検証スクリプト

**ファイルパス**: `scripts/test_screenshots.sh`

**概要**: 生成されたスクリーンショットを自動検証

**検証項目**:
1. ファイル存在確認（20枚）
2. 解像度確認（デバイスごとの正確性）
3. ファイル形式確認（PNG、sRGB）
4. ファイルサイズ確認（100KB〜10MB）

---

## 品質スコアリング

### スコア計算式

```
品質スコア = (PASS数 / 総テスト数) × 100
```

### 評価基準

| 項目 | 配点 | 詳細 |
|------|------|------|
| TC-01: スクリプト実行可能性 | 20点 | スクリプトが正常に実行できる |
| TC-02: 全ファイル生成 | 30点 | 20枚すべてが生成される |
| TC-03: 画像解像度正確性 | 30点 | 全画像が正しい解像度 |
| TC-04: ファイル形式妥当性 | 20点 | PNG形式、適切なサイズ |
| **TC-05: エラーハンドリング** | **+10点（ボーナス）** | 異常系の適切な処理 |

### 判定基準

| スコア | 判定 | 対応 |
|--------|------|------|
| 90点以上 | 合格 ✅ | 次のタスク（M10-T03）へ |
| 70〜89点 | 条件付き | 改善ループ（最大2回） |
| 70点未満 | 再実装 | 原因分析→修正 |

### 目標スコア

**100点**（TC-01〜TC-04全PASS + TC-05ボーナス）

---

## 実行フロー

### ステップ1: スクリーンショット生成

```bash
# 1. シミュレータ起動（必要に応じて）
xcrun simctl boot "iPhone 16 Pro Max"

# 2. スクリーンショット生成スクリプト実行
./scripts/generate_screenshots.sh

# 実行時間: 約5〜10分（4デバイス × 5画面）
```

### ステップ2: 自動検証実行

```bash
# 検証スクリプト実行
./scripts/test_screenshots.sh

# 実行時間: 約10秒
```

### ステップ3: 手動検証（オプション）

```bash
# スクリーンショットをFinderで開いて目視確認
open screenshots/

# チェック項目:
# - UI要素が正しく表示されているか
# - テキストが読みやすいか
# - ステータスバーが9:41 AM、フルバッテリーか
# - ダークモード対応が適切か
```

---

## よくある問題と対策

### 問題1: シミュレータが起動しない

**症状**: `xcrun simctl boot` がエラーで失敗

**原因**:
- Xcodeが正しくインストールされていない
- Command Line Toolsが設定されていない

**対策**:
```bash
# Command Line Tools設定確認
xcode-select -p

# 設定されていない場合
sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
```

---

### 問題2: スクリーンショットが真っ黒

**症状**: 撮影されたスクリーンショットが真っ黒または真っ白

**原因**:
- アプリが正しく起動していない
- UI描画が完了する前にスクリーンショットを撮影

**対策**:
```bash
# スクリプトにsleep追加（画面遷移後に待機時間を設ける）
sleep 2  # 2秒待機してから撮影
```

---

### 問題3: 解像度が合わない

**症状**: 期待した解像度と異なるサイズで保存される

**原因**:
- シミュレータのスケール設定が100%でない
- 間違ったデバイスでスクリーンショット撮影

**対策**:
```bash
# シミュレータのスケールを100%に設定
# Simulator.app > Window > Physical Size
# またはスクリプトで強制指定
xcrun simctl io booted screenshot --type=png --display=0
```

---

## まとめ

### 生成成果物

1. ✅ `scripts/generate_screenshots.sh`（新規作成）
2. ✅ `scripts/test_screenshots.sh`（新規作成）
3. ✅ `screenshots/` ディレクトリ（20枚のPNG画像）
4. ✅ `docs/M10-T02_TEST_SPECIFICATION.md`（本ドキュメント）

### テストケース数

- **自動テスト**: 4ケース（TC-01〜TC-04）
- **手動検証**: 1ケース（TC-05：異常系）
- **総合**: 5の検証ポイント

### 完了判定

- [ ] 自動テスト全PASS（4/4）
- [ ] スクリーンショット20枚生成
- [ ] 検証ツール2種類作成
- [ ] テスト仕様書作成

**結論**: M10-T02タスクのテストケース生成が**完了**し、次はスクリプト実装フェーズへ進みます。
