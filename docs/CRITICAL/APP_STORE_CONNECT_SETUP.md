# App Store Connect セットアップガイド

## 概要

このドキュメントは、LightRoll CleanerのマネタイズプランをApp Store Connectで設定する手順を説明します。

## 前提条件

- Apple Developer Program登録済み
- App Store Connectアカウント作成済み
- LightRoll Cleanerアプリが登録済み
- 銀行口座・税務情報が設定済み（収益受け取りに必要）

---

## Phase 1: サブスクリプショングループの作成

### 1.1 サブスクリプショングループとは

サブスクリプショングループは、同じサービスレベルの複数のサブスクリプション期間（月額・年額など）をグループ化する機能です。ユーザーは同じグループ内の異なる期間プランを選択できます。

### 1.2 グループ作成手順

1. **App Store Connectにログイン**
   - https://appstoreconnect.apple.com/

2. **アプリを選択**
   - 「マイApp」→「LightRoll Cleaner」を選択

3. **サブスクリプションセクションへ移動**
   - 左メニューから「サブスクリプション」を選択
   - 「+」ボタンをクリック

4. **サブスクリプショングループを作成**
   - 「サブスクリプショングループを作成」を選択
   - **参照名**: `Premium Subscription`
   - 「作成」をクリック

---

## Phase 2: 製品IDの登録

### 2.1 月額プレミアムプラン

1. **サブスクリプション追加**
   - サブスクリプショングループ内で「+」ボタン
   - 「サブスクリプションを作成」を選択

2. **基本情報**
   - **製品ID**: `monthly_premium`
     - ⚠️ 重要: ProductIdentifiers.swiftの`case monthlyPremium = "monthly_premium"`と一致させること
   - **参照名**: `Monthly Premium Plan`
   - 「作成」をクリック

3. **サブスクリプション期間**
   - **期間**: `1ヶ月`を選択

4. **サブスクリプション価格**
   - 「価格を追加」をクリック
   - **価格**: `$2.99` (または `¥300`)
     - App Storeの手数料を考慮して、実質$3になるように設定
   - **国/地域**: すべての地域を選択、またはターゲット市場のみ
   - 「次へ」をクリック

5. **無料トライアル設定**
   - 「導入オファー」セクションで「オファーを追加」
   - **オファータイプ**: `無料トライアル`
   - **期間**: `7日間`
   - **対象**: `新規サブスクライバー`
   - 「追加」をクリック

6. **ローカリゼーション**
   - 「ローカリゼーションを追加」をクリック
   - **言語**: 日本語
   - **サブスクリプション表示名**: `月額プレミアムプラン`
   - **説明**: `毎月自動更新されるプレミアムプラン。7日間の無料トライアル付き。`
   - 英語も追加:
     - **表示名**: `Monthly Premium Plan`
     - **説明**: `Premium plan with monthly auto-renewal. Includes 7-day free trial.`

7. **審査情報**
   - スクリーンショットをアップロード（サブスクリプション内容を示す画面）
   - 審査メモを追加（任意）

8. **保存**
   - 「保存」をクリック

### 2.2 年額プレミアムプラン

1. **サブスクリプション追加**
   - 同じサブスクリプショングループ内で「+」ボタン

2. **基本情報**
   - **製品ID**: `yearly_premium`
   - **参照名**: `Yearly Premium Plan`
   - 「作成」をクリック

3. **サブスクリプション期間**
   - **期間**: `1年`を選択

4. **サブスクリプション価格**
   - **価格**: `$19.99` (または `¥2,000`)
     - 月額プランの約50%割引に相当

5. **無料トライアル設定**
   - 年額プランには無料トライアルを設定**しない**
   - （月額プランで既にトライアルを提供しているため）

6. **ローカリゼーション**
   - 日本語:
     - **表示名**: `年額プレミアムプラン`
     - **説明**: `年1回自動更新されるプレミアムプラン。月額プランより約50%お得です。`
   - 英語:
     - **表示名**: `Yearly Premium Plan`
     - **説明**: `Premium plan with yearly auto-renewal. Save approximately 50% compared to monthly plan.`

7. **保存**

### 2.3 買い切りプラン (Lifetime)

買い切りプランは**非消費型アイテム**として別途登録します。

1. **App内課金セクションへ移動**
   - 左メニューから「App内課金」を選択
   - 「+」ボタンをクリック

2. **課金タイプ選択**
   - **非消費型**を選択
   - 「作成」をクリック

3. **基本情報**
   - **製品ID**: `lifetime_premium`
     - ⚠️ 重要: ProductIdentifiers.swiftと一致させること
   - **参照名**: `Lifetime Premium Purchase`

4. **価格設定**
   - **価格**: `$29.99` (または `¥3,000`)
   - すべての地域で同等価格を設定

5. **ローカリゼーション**
   - 日本語:
     - **表示名**: `Lifetimeプレミアムプラン`
     - **説明**: `一度きりの支払いで永久にすべてのプレミアム機能へアクセスできます。サブスクリプションなし。`
   - 英語:
     - **表示名**: `Lifetime Premium Plan`
     - **説明**: `One-time payment for permanent access to all premium features. No subscription required.`

6. **審査情報**
   - スクリーンショットをアップロード
   - 審査メモ: 「This is a one-time purchase for lifetime access to premium features.」

7. **保存**

---

## Phase 3: サブスクリプション設定の最適化

### 3.1 サブスクリプショングループレベルの設定

1. **グループローカリゼーション**
   - サブスクリプショングループを選択
   - 「グループのローカリゼーション」セクション
   - 日本語:
     - **App名**: `LightRoll Cleaner Premium`
     - **カスタムApp名**: （任意）
   - 英語:
     - **App名**: `LightRoll Cleaner Premium`

2. **ランク設定**
   - 年額プランを**ランク1**（最上位）に設定
   - 月額プランを**ランク2**に設定
   - これにより、年額プランが「最もお得」として推奨されます

### 3.2 ファミリー共有設定

1. **ファミリー共有を有効化**（任意）
   - サブスクリプション詳細画面
   - 「ファミリー共有」を**有効**に設定
   - これにより、家族全員がプレミアム機能を利用可能

---

## Phase 4: テスト設定

### 4.1 Sandboxテスターの作成

1. **App Store Connectの「ユーザーとアクセス」へ**
   - https://appstoreconnect.apple.com/access/testers

2. **Sandboxテスターを追加**
   - 「+」ボタンをクリック
   - **メールアドレス**: 実在しないテスト用メールアドレス
     - 例: `test.premium@example.com`
   - **パスワード**: 任意の強力なパスワード
   - **名前**: `Test User`
   - **国/地域**: `日本`
   - 「招待」をクリック

3. **複数のテスターを作成**（推奨）
   - Free→Premium転換テスト用
   - 無料トライアルテスト用
   - 年額プランテスト用
   - 買い切りテスト用

### 4.2 TestFlightでのテスト

1. **TestFlightビルドをアップロード**
   - Xcodeから「Archive」→「Distribute App」→「TestFlight」
   - ビルドをApp Store Connectにアップロード

2. **内部テスターを追加**
   - TestFlightセクションで「内部テスター」を選択
   - テスターを追加

3. **ビルドをテスターに公開**
   - アップロードしたビルドを選択
   - 「テストの詳細」→「内部テスター」に公開

4. **デバイスでテスト**
   - TestFlightアプリをインストール
   - LightRoll Cleanerをインストール
   - Sandboxテスターでサインイン
   - 課金フローをテスト

### 4.3 課金フローのテスト手順

#### テスト1: 7日間無料トライアル

1. デバイスでアプリを起動
2. Freeユーザーで50枚削除
3. LimitReachedSheetが表示されることを確認
4. 「7日間無料で試す」をタップ
5. 月額プランを選択
6. Sandboxテスターでサインイン
7. 「サブスクリプション登録」を確認
8. 無料トライアル期間が「7日間」と表示されることを確認
9. 「確認」をタップ
10. アプリに戻り、Premiumステータスになることを確認

#### テスト2: 年額プラン

1. 別のSandboxテスターでサインイン
2. Freeユーザーで制限到達
3. 年額プランを選択
4. 即座に課金されることを確認（無料トライアルなし）
5. Premiumステータスになることを確認

#### テスト3: 買い切りプラン

1. 別のSandboxテスターでサインイン
2. Lifetimeプランを選択
3. 一度きりの支払いで完了
4. Premiumステータスになることを確認
5. アプリを削除→再インストール
6. 購入がリストアされることを確認

---

## Phase 5: 本番リリース準備

### 5.1 価格戦略の最終確認

#### 推奨価格設定

| プラン | 米国価格 | 日本価格 | 備考 |
|--------|---------|---------|------|
| 月額 | $2.99 | ¥300 | 7日間無料トライアル付き |
| 年額 | $19.99 | ¥2,000 | 月額の約45%割引 |
| 買い切り | $29.99 | ¥3,000 | サブスクなし永久利用 |

#### 価格調整のヒント

- **地域別価格**: 購買力に応じて調整
  - インド: より低価格に設定
  - 欧州: ユーロ圏で統一価格
- **プロモーション**: 初回リリース時は期間限定で割引を検討

### 5.2 審査用メタデータの準備

#### 必須スクリーンショット

1. **Paywallスクリーンショット**
   - LimitReachedSheetの画面
   - 3つのプラン比較が表示されている状態
   - 7日間無料トライアルバナーが見える

2. **プレミアム機能スクリーンショット**
   - 無制限スキャン画面
   - 無制限削除画面
   - 広告非表示の快適な操作画面

3. **設定画面**
   - サブスクリプション管理画面

#### 審査メモ

```
【サブスクリプション説明】
このアプリは写真整理アプリで、以下の3つの課金オプションを提供しています:

1. 月額プレミアムプラン ($2.99/月)
   - 7日間の無料トライアル付き
   - 無制限スキャン・削除
   - 広告非表示

2. 年額プレミアムプラン ($19.99/年)
   - 月額プランより約45%お得
   - 無制限スキャン・削除
   - 広告非表示

3. 買い切りプラン ($29.99 一度きり)
   - サブスクリプションなし
   - 永久にすべてのプレミアム機能を利用可能

【Freeユーザーの制限】
- 初回スキャンのみ可能
- 生涯50枚まで削除可能
- 広告表示あり

【テストアカウント】
Sandbox環境でテスト可能です。審査時には以下のテストアカウントをご利用ください:
- Email: test.premium@example.com
- Password: TestPass123!

【プライバシーポリシー・利用規約】
アプリ内の「その他」→「プライバシーポリシー」「利用規約」から確認可能です。
```

### 5.3 App Store Connect審査提出

1. **アプリバージョンを作成**
   - 「マイApp」→「LightRoll Cleaner」
   - 「+バージョン」→ バージョン番号入力（例: `1.0`）

2. **ビルドを選択**
   - アップロードしたビルドを選択

3. **App情報を入力**
   - スクリーンショット（各デバイスサイズ）
   - アプリの説明
   - キーワード
   - サポートURL
   - プライバシーポリシーURL

4. **価格と配信状況**
   - 価格: 無料（App内課金あり）
   - 配信地域: すべての地域

5. **審査用情報**
   - 審査メモを追加（上記参照）
   - テストアカウント情報

6. **審査に提出**
   - 「審査に提出」をクリック
   - 通常1〜3日で審査結果が通知される

---

## Phase 6: リリース後の監視

### 6.1 App Store Connectダッシュボード

リリース後は以下の指標を定期的に確認:

1. **売上とトレンド**
   - https://appstoreconnect.apple.com/analytics/sales
   - 日次・週次・月次の売上
   - プランごとの収益比較

2. **サブスクリプション指標**
   - **新規サブスクライバー数**
   - **アクティブサブスクライバー数**
   - **解約率 (Churn Rate)**
   - **トライアル→有料転換率**
   - **プランごとの比率**

3. **重要KPI**
   - Free→Premium転換率
   - 7日間無料トライアル継続率
   - 年額vs月額の選択比率
   - Lifetime購入率

### 6.2 価格最適化

#### データ収集期間: 最初の1ヶ月

- 各プランの選択率を記録
- 無料トライアル継続率を測定
- 地域別の購入傾向を分析

#### 最適化施策（2ヶ月目以降）

1. **年額プランの割引率調整**
   - 現在: 45%割引
   - 選択率が低い場合 → 50%割引に引き上げ
   - 選択率が高い場合 → 40%割引でも収益最大化

2. **無料トライアル期間の調整**
   - 現在: 7日間
   - 継続率が低い場合 → 14日間に延長検討
   - 継続率が高い場合 → 5日間に短縮でも可

3. **地域別価格調整**
   - 購入率が低い地域 → 価格を下げる
   - 購入率が高い地域 → 現状維持または微増

---

## トラブルシューティング

### 問題1: 「製品IDが見つかりません」エラー

**原因**: App Store Connectで製品が承認されていない、またはProductIdentifiers.swiftのIDが一致していない

**解決策**:
1. App Store Connectで製品ステータスを確認（「承認待ち」→「販売可能」になっているか）
2. ProductIdentifiers.swiftの`rawValue`が完全一致しているか確認
   ```swift
   case monthlyPremium = "monthly_premium"  // App Store Connectと一致
   ```
3. ビルドを再アップロードして、App Store Connectが最新版を認識しているか確認

### 問題2: 無料トライアルが表示されない

**原因**: App Store Connectで導入オファーが設定されていない

**解決策**:
1. 月額プランの「導入オファー」セクションを確認
2. 無料トライアル（7日間）が設定されているか確認
3. 対象が「新規サブスクライバー」になっているか確認

### 問題3: Sandboxで課金テストができない

**原因**: Sandboxテスターでサインインしていない、またはデバイスが本番環境に接続している

**解決策**:
1. デバイスの「設定」→「App Store」→「Sandbox アカウント」でSandboxテスターにサインイン
2. 本番のApp Storeアカウントからサインアウト
3. アプリを削除→再インストールしてクリーンな状態でテスト

### 問題4: 購入後もFreeユーザーのまま

**原因**: PremiumManagerのステータス更新が動作していない

**解決策**:
1. トランザクション監視が開始されているか確認
   ```swift
   premiumManager.startTransactionMonitoring()
   ```
2. `checkPremiumStatus()`が呼ばれているか確認
3. ログで購入トランザクションが検出されているか確認

---

## 次のステップ

App Store Connectの設定が完了したら:

1. **統合テスト**: `MONETIZATION_INTEGRATION.md`に従ってアプリに統合
2. **Firebase Analytics**: イベントトラッキング実装
3. **Phase 2開始**: A/Bテスト機能実装

---

## 参考リンク

- [App Store Connect公式ガイド](https://developer.apple.com/app-store-connect/)
- [サブスクリプション設定ガイド](https://developer.apple.com/help/app-store-connect/manage-subscriptions/)
- [StoreKit 2ドキュメント](https://developer.apple.com/documentation/storekit)
- [MONETIZATION_STRATEGY.md](../../MONETIZATION_STRATEGY.md)
- [MONETIZATION_INTEGRATION.md](./MONETIZATION_INTEGRATION.md)
