# LightRoll Cleaner - Core Rules

## 1. プロジェクト概要

**LightRoll Cleaner**は、iOSデバイスのカメラロールから不要な写真を自動検出・グルーピングし、効率的に削除することでストレージ容量を解放する写真クリーナーアプリです。

---

## 2. 開発原則

### 2.1 アーキテクチャ原則
- **MVVM + Clean Architecture**: ビューとビジネスロジックの完全分離
- **Protocol Oriented Programming**: 依存性注入とテスタビリティの確保
- **Single Responsibility**: 各コンポーネントは単一の責務のみを持つ
- **Dependency Inversion**: 上位モジュールは下位モジュールに依存しない

### 2.2 コーディング規約
- **言語**: Swift 5.9+
- **UIフレームワーク**: SwiftUI
- **命名規則**: Swift API Design Guidelines準拠
- **ファイル構造**: 1ファイル1型（例外: 密接に関連する小型のヘルパー型）
- **コメント**: 公開APIには必ずドキュメントコメント（///）を付与

### 2.3 品質基準
- **テストカバレッジ**: ビジネスロジック80%以上
- **ビルド時間**: インクリメンタルビルド30秒以内
- **起動時間**: コールドスタート2秒以内
- **メモリ使用量**: スキャン中でも200MB以内

---

## 3. モジュール構成

| モジュールID | モジュール名 | 責務 |
|-------------|-------------|------|
| M1 | Core Infrastructure | 基盤機能、DI、設定管理 |
| M2 | Photo Access | Photos Frameworkとの統合、権限管理 |
| M3 | Image Analysis | 画像分析、類似度判定、グルーピング |
| M4 | UI Components | 再利用可能なUIコンポーネント |
| M5 | Dashboard | ストレージ統計、ダッシュボード画面 |
| M6 | Deletion & Safety | 削除処理、ゴミ箱機能、復元 |
| M7 | Notifications | ローカル通知、リマインダー |
| M8 | Settings | アプリ設定、ユーザー設定 |
| M9 | Monetization | 課金、広告、機能制限 |

---

## 4. 開発フロー

### 4.1 タスク管理
1. タスクIDは `M{モジュール番号}-T{タスク番号}` 形式（例: M1-T01）
2. 1タスクの作業時間は最大3時間
3. 各タスクには最低3つのテストケースを定義
4. タスク完了時は必ずユニットテストを実行

### 4.2 コミット規約
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**: feat, fix, docs, style, refactor, test, chore
**Scope**: モジュール名またはファイル名

### 4.3 ブランチ戦略
- `main`: 本番リリース可能な状態
- `develop`: 開発統合ブランチ
- `feature/M{n}-T{nn}-description`: 機能開発ブランチ
- `fix/issue-{number}`: バグ修正ブランチ

---

## 5. セキュリティ要件

### 5.1 データ保護
- ユーザーの写真データはデバイス外に送信しない
- 分析処理はすべてオンデバイスで実行
- ゴミ箱内のデータは暗号化して保存

### 5.2 権限管理
- Photos Frameworkへのアクセスは最小限の権限で
- 通知権限は必要時にのみリクエスト
- 権限が拒否された場合の適切なフォールバック

### 5.3 プライバシー
- トラッキングは行わない
- クラッシュレポートは匿名化
- 収集データはApp Privacy Labelに明記

---

## 6. パフォーマンス要件

### 6.1 スキャン性能
- 1000枚の写真: 10秒以内でスキャン完了
- 10000枚の写真: 60秒以内でスキャン完了
- バックグラウンドスキャン対応

### 6.2 メモリ管理
- 大量画像処理時のメモリ圧力を監視
- 必要に応じてサムネイルを使用
- AutoreleasepoolでメモリをGC

### 6.3 バッテリー消費
- スキャン中のCPU使用率: 平均50%以下
- アイドル時のバックグラウンド処理は最小限

---

## 7. コンテキスト最適化ポリシー

### 7.1 AIセッション管理
- 各セッション開始時に`CONTEXT_HANDOFF.json`を読み込む
- セッション終了時に状態を更新して保存
- 長期記憶は`docs/IMPLEMENTED.md`に集約

### 7.2 ドキュメント階層
```
docs/
├── CRITICAL/           # 必ず読む（CORE_RULES, ARCHITECTURE）
├── modules/            # 作業対象モジュールのみ読む
├── archive/            # 基本的に参照しない
├── TASKS.md            # アクティブなタスク一覧
├── PROGRESS.md         # 直近10件の進捗
├── IMPLEMENTED.md      # 実装済み機能一覧
├── PROJECT_SUMMARY.md  # プロジェクト概要（500文字）
├── TEST_RESULTS.md     # テスト結果
└── SECURITY_AUDIT.md   # セキュリティ監査
```

### 7.3 タスク実行ルール
1. 作業開始前に`TASKS.md`で対象タスクを確認
2. 該当モジュールの`MODULE_*.md`を参照
3. 実装後はテストを実行し`TEST_RESULTS.md`を更新
4. 完了タスクは`IMPLEMENTED.md`に反映

---

## 8. 禁止事項

- [ ] ユーザーの同意なく写真を削除しない
- [ ] ネットワーク経由で写真データを送信しない
- [ ] バックグラウンドで過度なリソースを消費しない
- [ ] 課金状態を偽装する処理を実装しない
- [ ] テストなしでのプロダクションコードマージ

---

## 9. 依存ライブラリ方針

### 9.1 使用可能
- Apple純正フレームワーク（Photos, Vision, CoreML）
- StoreKit 2（課金）
- Google Mobile Ads SDK（広告）

### 9.2 要検討
- サードパーティ画像処理ライブラリ
- アナリティクスSDK

### 9.3 使用禁止
- 写真をクラウドに送信するライブラリ
- 非公式API

---

## 10. バージョン管理

- **現在バージョン**: 0.1.0（設計フェーズ）
- **最小対応OS**: iOS 16.0
- **最小対応デバイス**: iPhone 8以降

---

*最終更新: 2025-11-27*
